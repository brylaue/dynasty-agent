<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynasty Agent</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">Dynasty Agent</div>
    <div class="spacer"></div>
    <div id="auth-area"></div>
  </header>
  <main class="page" style="max-width:720px;">
    <h1>Fantasy research, tailored to your Sleeper or Yahoo league</h1>
    <p class="meta">Sign in to personalize your news feed and save your team preferences.</p>
    <div class="toolbar">
      <button id="google-signin" class="btn btn-primary">Sign in with Google</button>
      <button id="signout" class="btn btn-secondary" style="display:none;">Sign out</button>
    </div>
    <div class="composer" style="gap:8px;">
      <select id="provider">
        <option value="sleeper">Sleeper</option>
        <option value="yahoo">Yahoo</option>
      </select>
      <input id="landing-league" type="text" placeholder="Sleeper League ID" />
      <button id="continue" class="btn btn-primary">Continue</button>
    </div>
    <p class="meta">Find League ID in Sleeper → League → Settings → League ID.</p>
  </main>
  <script>
    let SB = null; let SUPABASE_URL = ''; let SUPABASE_ANON = '';
    async function initSupabase() {
      try {
        const cfg = await (await fetch('/api/public/config')).json();
        SUPABASE_URL = cfg.supabase_url || '';
        SUPABASE_ANON = cfg.supabase_anon || '';
        if (SUPABASE_URL && SUPABASE_ANON) {
          SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        }
      } catch {}
      updateAuthUI();
    }

    async function updateAuthUI() {
      const signinBtn = document.getElementById('google-signin');
      const signoutBtn = document.getElementById('signout');
      // Keep sign-in visible even if config missing; clicking will alert
      if (!SB) { signinBtn.style.display='inline-block'; signoutBtn.style.display='none'; return; }
      const { data: { session } } = await SB.auth.getSession();
      if (session) { signinBtn.style.display = 'none'; signoutBtn.style.display = 'inline-block'; }
      else { signinBtn.style.display = 'inline-block'; signoutBtn.style.display = 'none'; }
    }

    document.getElementById('google-signin').addEventListener('click', async ()=>{
      if (!SB) return alert('Auth not configured');
      const { error } = await SB.auth.signInWithOAuth({ provider: 'google' });
      if (error) alert(error.message);
    });
    document.getElementById('signout').addEventListener('click', async ()=>{ if (SB) await SB.auth.signOut(); updateAuthUI(); });

    const providerSel = document.getElementById('provider');
    const leagueInput = document.getElementById('landing-league');
    providerSel.addEventListener('change', ()=>{
      if (providerSel.value === 'yahoo') {
        leagueInput.value = '';
        leagueInput.placeholder = 'Yahoo uses OAuth (no league id)';
        leagueInput.disabled = true;
      } else {
        leagueInput.placeholder = 'Sleeper League ID';
        leagueInput.disabled = false;
      }
    });
    // initialize toggle state
    providerSel.dispatchEvent(new Event('change'));

    document.getElementById('continue').addEventListener('click', async ()=>{
      const prov = providerSel.value;
      const league = leagueInput.value.trim();
      localStorage.setItem('provider', prov);
      if (prov === 'sleeper' && league) localStorage.setItem('league_id', league); else localStorage.removeItem('league_id');
      if (SB) {
        const { data: { session } } = await SB.auth.getSession();
        if (session) localStorage.setItem('sb_token', session.access_token);
      }
      window.location.href = '/app.html';
    });

    initSupabase();
  </script>
</body>
</html>